<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saved Teachings</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 18px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .btn { padding:10px 12px; border:0; border-radius:10px; cursor:pointer; }
    .btn-primary { background:#111; color:#fff; }
    .btn-ghost { background:#f2f2f2; color:#111; }
    .list { margin-top: 14px; display:flex; flex-direction:column; gap:12px; }
    .card { border:1px solid #e6e6e6; border-radius:14px; padding:14px; }
    .title { font-weight:700; margin:0 0 6px 0; }
    .meta { font-size: 13px; opacity: .75; margin:0 0 10px 0; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    a { color:#0b57d0; word-break: break-word; }
    .empty { margin-top: 20px; padding: 14px; border-radius: 14px; background:#fafafa; border:1px dashed #ddd; }
  </style>
</head>
<body>
  <div class="top">
    <h2 style="margin:0;">Saved Teachings</h2>
    <div class="row">
      <button class="btn btn-ghost" onclick="history.back()">Back</button>
      <button class="btn btn-ghost" onclick="clearAll()">Clear</button>
    </div>
  </div>

  <div id="list" class="list"></div>

  <script type="module">
    import { Preferences } from '@capacitor/preferences';

    const STORAGE_KEY = "pf_saved_teachings_v1";

    async function loadSaved() {
      try {
        const { value } = await Preferences.get({ key: STORAGE_KEY });
        return JSON.parse(value || "[]");
      } catch (e) {
        return [];
      }
    }

    async function saveAll(items) {
      await Preferences.set({
        key: STORAGE_KEY,
        value: JSON.stringify(items)
      });
    }

    function fmt(iso) {
      try { return new Date(iso).toLocaleString(); } catch(e) { return ""; }
    }

    function escapeHtml(str) {
      return (str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function render() {
      const items = await loadSaved();
      const el = document.getElementById("list");
      el.innerHTML = "";

      if (!items.length) {
        el.innerHTML = `<div class="empty">No saved teachings yet. Go back and tap "Save" on a teaching.</div>`;
        return;
      }

      items.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <p class="title">${escapeHtml(item.title)}</p>
          <p class="meta">${item.source} â€¢ Saved ${fmt(item.savedAt)}</p>
          <div class="row">
            <a href="${item.url}" target="_blank" rel="noopener">Open</a>
            <button class="btn btn-ghost" data-id="${item.id}">Remove</button>
          </div>
          <div style="margin-top:8px; font-size:13px; opacity:.75;">
            ${escapeHtml(item.url)}
          </div>
        `;
        el.appendChild(card);
      });

      // Add event listeners to remove buttons
      document.querySelectorAll('[data-id]').forEach(btn => {
        btn.addEventListener('click', () => removeOne(btn.dataset.id));
      });
    }

    async function removeOne(id) {
      const items = await loadSaved();
      const filtered = items.filter((x) => x.id !== id);
      await saveAll(filtered);
      await render();
    }

    window.clearAll = async function() {
      if (confirm("Clear all saved teachings?")) {
        await Preferences.remove({ key: STORAGE_KEY });
        await render();
      }
    }

    // Initialize
    render();
  </script>
</body>
</html>