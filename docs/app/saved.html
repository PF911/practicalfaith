<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Saved Teachings</title>
  <script src="capacitor.js"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      padding: 16px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }
    .btn-clear {
      padding: 8px 16px;
      background: #ff3b30;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .teaching {
      background: white;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .teaching-title {
      font-weight: 600;
      font-size: 16px;
      margin: 0 0 6px 0;
      line-height: 1.3;
    }
    .teaching-meta {
      font-size: 13px;
      color: #666;
      margin: 0 0 12px 0;
    }
    .platform-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      margin-right: 6px;
    }
    .youtube { background: #ff0000; color: white; }
    .spotify { background: #1DB954; color: white; }
    .buttons {
      display: flex;
      gap: 8px;
    }
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-open {
      background: #007AFF;
      color: white;
    }
    .btn-remove {
      background: #E5E5EA;
      color: #000;
    }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .empty h2 {
      margin: 0 0 8px 0;
      font-size: 22px;
    }
    .empty p {
      margin: 0;
      font-size: 15px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Saved Teachings</h1>
    <button class="btn-clear" onclick="clearAll()" style="display:none;" id="clear-btn">Clear All</button>
  </div>

  <div id="teachings-list">
    <div class="loading">Loading saved teachings...</div>
  </div>

  <script>
    (function() {
      const STORAGE_KEY = "pf_saved_teachings_v1";
      let savedTeachings = [];
      let Preferences, Browser;

      function initialize() {
        if (window.Capacitor && window.Capacitor.Plugins) {
          Preferences = window.Capacitor.Plugins.Preferences;
          Browser = window.Capacitor.Plugins.Browser;
        }
        
        loadSavedTeachings().then(renderTeachings);
      }

      async function loadSavedTeachings() {
        try {
          if (Preferences) {
            const result = await Preferences.get({ key: STORAGE_KEY });
            savedTeachings = JSON.parse(result.value || "[]");
          }
          return savedTeachings;
        } catch (e) {
          console.error('Error loading saved:', e);
          return [];
        }
      }

      async function removeTeaching(id) {
        try {
          savedTeachings = savedTeachings.filter(t => t.id !== id);
          if (Preferences) {
            await Preferences.set({
              key: STORAGE_KEY,
              value: JSON.stringify(savedTeachings)
            });
          }
          renderTeachings();
        } catch (e) {
          alert("Error removing teaching");
        }
      }

      window.clearAll = async function() {
        if (confirm("Clear all saved teachings?")) {
          try {
            if (Preferences) {
              await Preferences.remove({ key: STORAGE_KEY });
            }
            savedTeachings = [];
            renderTeachings();
          } catch (e) {
            alert("Error clearing teachings");
          }
        }
      }

      async function openTeaching(url) {
        try {
          if (Browser) {
            await Browser.open({ url: url });
          } else {
            window.open(url, '_blank');
          }
        } catch (e) {
          window.open(url, '_blank');
        }
      }

      function renderTeachings() {
        const container = document.getElementById('teachings-list');
        const clearBtn = document.getElementById('clear-btn');
        
        if (savedTeachings.length === 0) {
          clearBtn.style.display = 'none';
          container.innerHTML = `
            <div class="empty">
              <div class="empty-icon">üìö</div>
              <h2>No Saved Teachings Yet</h2>
              <p>When you save teachings from sermons,<br>Spotify, or books, they'll appear here.</p>
            </div>
          `;
          return;
        }

        clearBtn.style.display = 'block';
        container.innerHTML = '';
        
        savedTeachings.forEach(function(teaching) {
          const div = document.createElement('div');
          div.className = 'teaching';
          
          const savedDate = new Date(teaching.savedAt).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });
          
          div.innerHTML = 
            '<div class="teaching-title">' + teaching.title + '</div>' +
            '<div class="teaching-meta">' +
              '<span class="platform-badge ' + teaching.source.toLowerCase() + '">' + teaching.source + '</span>' +
              'Saved ' + savedDate +
            '</div>' +
            '<div class="buttons">' +
              '<button class="btn btn-open">' +
                (teaching.source === 'YouTube' ? '‚ñ∂Ô∏è Watch' : 'üéß Listen') +
              '</button>' +
              '<button class="btn btn-remove">üóëÔ∏è Remove</button>' +
            '</div>';
          
          const openBtn = div.querySelector('.btn-open');
          const removeBtn = div.querySelector('.btn-remove');
          
          openBtn.addEventListener('click', function() {
            openTeaching(teaching.url);
          });
          
          removeBtn.addEventListener('click', function() {
            removeTeaching(teaching.id);
          });
          
          container.appendChild(div);
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
      } else {
        setTimeout(initialize, 100);
      }
    })();
  </script>
</body>
</html>