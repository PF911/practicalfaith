<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sermons & Teachings</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      padding: 16px;
    }
    .header {
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 700;
    }
    .header p {
      margin: 0;
      color: #666;
      font-size: 15px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .tab {
      padding: 10px 20px;
      background: white;
      border: none;
      border-radius: 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .tab.active {
      background: #007AFF;
      color: white;
    }
    .teaching {
      background: white;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .teaching-title {
      font-weight: 600;
      font-size: 16px;
      margin: 0 0 6px 0;
      line-height: 1.3;
    }
    .teaching-meta {
      font-size: 13px;
      color: #666;
      margin: 0 0 8px 0;
    }
    .teaching-desc {
      font-size: 14px;
      color: #333;
      margin: 0 0 12px 0;
      line-height: 1.4;
    }
    .platform-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      margin-right: 6px;
    }
    .youtube { background: #ff0000; color: white; }
    .spotify { background: #1DB954; color: white; }
    .buttons {
      display: flex;
      gap: 8px;
    }
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-watch {
      background: #007AFF;
      color: white;
    }
    .btn-save {
      background: #E5E5EA;
      color: #000;
    }
    .btn-save.saved {
      background: #34C759;
      color: white;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      text-align: center;
      padding: 20px;
      color: #ff3b30;
      background: #fff;
      border-radius: 12px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Sermons & Teachings</h1>
    <p>Watch, listen, and save for later</p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="all">All</button>
    <button class="tab" data-tab="youtube">YouTube</button>
    <button class="tab" data-tab="spotify">Spotify</button>
  </div>

  <div id="teachings-list">
    <div class="loading">Loading teachings...</div>
  </div>

  <script type="module">
    import { Preferences } from '@capacitor/preferences';
    import { Browser } from '@capacitor/browser';

    const STORAGE_KEY = "pf_saved_teachings_v1";
    const SPOTIFY_RSS = "https://anchor.fm/s/ff0d794c/podcast/rss";
    const YOUTUBE_PLAYLIST = "https://www.youtube.com/playlist?list=PLxaBH-TdMi2-RSBZMPODyMJQ5aWdAFcjI"; // Your actual playlist
    
    let teachings = [];
    let currentTab = 'all';
    let savedTeachings = [];

    // Manual YouTube videos (since YouTube RSS requires channel ID, not playlist)
    // You'll update these when you post new videos
    const youtubeVideos = [
      {
        title: "Learning to Let Go",
        platform: "YouTube",
        date: "2026-01-12",
        url: "https://www.youtube.com/watch?v=YOUR_ACTUAL_VIDEO_ID",
        duration: "40:48",
        description: "Making the Bible Relevant for Today's Living"
      },
      {
        title: "When God Changes the Menu - A Message for the New Year",
        platform: "YouTube",
        date: "2026-01-05",
        url: "https://www.youtube.com/watch?v=YOUR_ACTUAL_VIDEO_ID",
        duration: "35:22",
        description: "Starting the year with faith and purpose"
      }
    ];

    async function fetchSpotifyEpisodes() {
      try {
        const response = await fetch(SPOTIFY_RSS);
        if (!response.ok) throw new Error('Failed to fetch RSS');
        
        const text = await response.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');
        
        const items = xml.querySelectorAll('item');
        const episodes = [];
        
        items.forEach(item => {
          const title = item.querySelector('title')?.textContent || 'Untitled';
          const link = item.querySelector('enclosure')?.getAttribute('url') || 
                      item.querySelector('link')?.textContent || '';
          const pubDate = item.querySelector('pubDate')?.textContent || '';
          const description = item.querySelector('description')?.textContent || '';
          const duration = item.querySelector('duration')?.textContent || '';
          
          // Convert Anchor URL to Spotify URL if needed
          let spotifyUrl = link;
          if (link.includes('anchor.fm')) {
            // Extract episode ID and construct Spotify URL
            // This might need adjustment based on your RSS structure
            spotifyUrl = link;
          }
          
          // Format date
          let formattedDate = '';
          if (pubDate) {
            try {
              const date = new Date(pubDate);
              formattedDate = date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              });
            } catch (e) {
              formattedDate = pubDate;
            }
          }
          
          episodes.push({
            title,
            platform: "Spotify",
            date: formattedDate,
            url: spotifyUrl,
            duration: duration || 'Unknown',
            description: description.replace(/<[^>]*>/g, '').substring(0, 150) + '...'
          });
        });
        
        return episodes;
      } catch (e) {
        console.error('Error fetching Spotify RSS:', e);
        return [];
      }
    }

    async function loadAllTeachings() {
      try {
        const spotifyEpisodes = await fetchSpotifyEpisodes();
        teachings = [...youtubeVideos, ...spotifyEpisodes];
        
        // Sort by date (newest first)
        teachings.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateB - dateA;
        });
        
        return teachings.length > 0;
      } catch (e) {
        console.error('Error loading teachings:', e);
        return false;
      }
    }

    async function loadSavedTeachings() {
      try {
        const { value } = await Preferences.get({ key: STORAGE_KEY });
        savedTeachings = JSON.parse(value || "[]");
      } catch (e) {
        savedTeachings = [];
      }
    }

    function isTeachingSaved(url) {
      return savedTeachings.some(t => t.url === url);
    }

    async function saveTeaching(teaching) {
      try {
        if (isTeachingSaved(teaching.url)) {
          alert("This teaching is already saved!");
          return;
        }

        savedTeachings.unshift({
          id: String(Date.now()),
          title: teaching.title,
          url: teaching.url,
          source: teaching.platform,
          savedAt: new Date().toISOString()
        });

        await Preferences.set({
          key: STORAGE_KEY,
          value: JSON.stringify(savedTeachings)
        });

        alert("‚úì Saved! View in Saved Teachings.");
        renderTeachings();
      } catch (e) {
        alert("Error saving. Please try again.");
      }
    }

    async function openTeaching(url) {
      await Browser.open({ url, presentationStyle: 'fullscreen' });
    }

    function getFilteredTeachings() {
      if (currentTab === 'all') return teachings;
      return teachings.filter(t => t.platform.toLowerCase() === currentTab);
    }

    function renderTeachings() {
      const container = document.getElementById('teachings-list');
      const filtered = getFilteredTeachings();
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="loading">No teachings found</div>';
        return;
      }

      container.innerHTML = '';
      
      filtered.forEach(teaching => {
        const saved = isTeachingSaved(teaching.url);
        const div = document.createElement('div');
        div.className = 'teaching';
        
        const descriptionHtml = teaching.description ? 
          `<div class="teaching-desc">${teaching.description}</div>` : '';
        
        div.innerHTML = `
          <div class="teaching-title">${teaching.title}</div>
          <div class="teaching-meta">
            <span class="platform-badge ${teaching.platform.toLowerCase()}">${teaching.platform}</span>
            ${teaching.date}${teaching.duration !== 'Unknown' ? ' ‚Ä¢ ' + teaching.duration : ''}
          </div>
          ${descriptionHtml}
          <div class="buttons">
            <button class="btn btn-watch">
              ${teaching.platform === 'YouTube' ? '‚ñ∂Ô∏è Watch' : 'üéß Listen'}
            </button>
            <button class="btn btn-save ${saved ? 'saved' : ''}">
              ${saved ? '‚úì Saved' : 'üíæ Save'}
            </button>
          </div>
        `;
        
        const watchBtn = div.querySelector('.btn-watch');
        const saveBtn = div.querySelector('.btn-save');
        
        watchBtn.addEventListener('click', () => openTeaching(teaching.url));
        
        if (!saved) {
          saveBtn.addEventListener('click', () => saveTeaching(teaching));
        }
        
        container.appendChild(div);
      });
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        renderTeachings();
      });
    });

    // Initialize
    (async () => {
      await loadSavedTeachings();
      const success = await loadAllTeachings();
      
      if (success) {
        renderTeachings();
      } else {
        document.getElementById('teachings-list').innerHTML = 
          '<div class="error">Unable to load teachings. Please check your connection and try again.</div>';
      }
    })();
  </script>
</body>
</html>